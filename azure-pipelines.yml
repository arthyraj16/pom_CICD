trigger:
- main

pool:
  name: 'Sam_Latest'

variables:
  # This points to the folder where source code is checked out
  reportPath: '$(System.DefaultWorkingDirectory)/junit-report.xml'

steps:
# 1. RUN THE POWERSHELL SCRIPT
- task: PowerShell@2
  displayName: 'Run Testsigma Script'
  inputs:
    filePath: 'testsigma_cicd.ps1' # Ensure this file is in your repo root
    pwsh: true # Use PowerShell Core
  env:
    # Map the Azure Secret Variable to the Script Env Variable
    TESTSIGMA_API_KEY: $(TESTSIGMA_API_KEY) 
    REPORT_FILE_PATH: $(reportPath)
    MAX_WAIT_TIME_FOR_SCRIPT_TO_EXIT: "180" # 180 Minutes

# 2. PARSE REPORT AND SET STATUS VARIABLE
- task: PowerShell@2
  displayName: 'Determine Status'
  inputs:
    targetType: 'inline'
    pwsh: false
    script: |
      $xmlPath = "$(reportPath)"
      $finalStatus = "UNKNOWN"

      if (Test-Path $xmlPath) {
        [xml]$xml = Get-Content $xmlPath
        $failures = 0
        $errors = 0

        # Handle multiple testsuites
        if ($xml.testsuites.testsuite) {
            foreach ($suite in $xml.testsuites.testsuite) {
                $failures += [int]$suite.failures
                $errors += [int]$suite.errors
            }
        } 
        # Handle single testsuite
        elseif ($xml.testsuite) {
            $failures += [int]$xml.testsuite.failures
            $errors += [int]$xml.testsuite.errors
        }

        Write-Host "Total Failures: $failures, Total Errors: $errors"

        if ($failures -eq 0 -and $errors -eq 0) {
          $finalStatus = "PASSED"
        } else {
          $finalStatus = "FAILED"
        }
      } else {
        Write-Warning "Report file not found. Script might have timed out."
        $finalStatus = "TIMEOUT"
      }
      
      Write-Host "Final Status determined: $finalStatus"
      
      # This command sets a variable available to future steps in Azure DevOps
      Write-Host "##vso[task.setvariable variable=ExecutionResult]$finalStatus"

# 3. CREATE GITHUB RELEASE
- task: GitHubRelease@1
  displayName: 'Create GitHub Release'
  condition: always() # Run even if the tests failed
  inputs:
    gitHubConnection: 'arthy' # MUST match the name in Project Settings -> Service Connections
    repositoryName: '$(Build.Repository.Name)'
    action: 'create'
    target: '$(Build.SourceVersion)'
    tagSource: 'userSpecifiedTag'
    tag: 'build-$(Build.BuildId)'
    title: 'Test Status $(ExecutionResult)'
    releaseNotesSource: 'inline'
    releaseNotesInline: |
      ### Automated Test Execution
      **Result:** $(ExecutionResult)
      
      **Test Plan ID:** 2493
      **Azure Build ID:** $(Build.BuildId)
      
      _This release was automatically generated via Azure DevOps._
    assets: '$(reportPath)' # Optional: Attaches the XML report to the release
