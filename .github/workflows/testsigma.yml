name: Testsigma Run and Release
on:
  push:
    branches: [ main ]
  workflow_dispatch:
permissions:
  contents: write
jobs:
  test-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Run Testsigma Script
        shell: pwsh
        env:
          TESTSIGMA_API_KEY: ${{ secrets.TESTSIGMA_API_KEY }}
          REPORT_FILE_PATH: "junit-report.xml"
          MAX_WAIT_TIME_FOR_SCRIPT_TO_EXIT: "180" # 180 Minutes
        run: ./testsigma_cicd.ps1
      - name: Determine Status from Report
        id: status_check
        shell: pwsh
        run: |
          $reportPath = "junit-report.xml"
          $finalStatus = "UNKNOWN"
          if (Test-Path $reportPath) {
            # Parse the XML generated by your script
            [xml]$xml = Get-Content $reportPath
            $failures = 0
            $errors = 0
            # Handle multiple testsuites
            if ($xml.testsuites.testsuite) {
                foreach ($suite in $xml.testsuites.testsuite) {
                    $failures += [int]$suite.failures
                    $errors += [int]$suite.errors
                }
            }
            # Handle single testsuite
            elseif ($xml.testsuite) {
                $failures += [int]$xml.testsuite.failures
                $errors += [int]$xml.testsuite.errors
            }
            Write-Host "Total Failures: $failures, Total Errors: $errors"
            if ($failures -eq 0 -and $errors -eq 0) {
              $finalStatus = "PASSED"
            } else {
              $finalStatus = "FAILED"
            }
          } else {
            Write-Warning "Report file not found. Script might have timed out."
            $finalStatus = "TIMEOUT"
          }
          Write-Host "Final Status for Release: $finalStatus"
          "result=$finalStatus" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: always() # Run even if tests fail
        with:
          tag_name: build-${{ github.run_number }}
          name: Test Status ${{ steps.status_check.outputs.result }}
          body: |
            ### Automated Test Execution
            **Result:** ${{ steps.status_check.outputs.result }}
            **Test Plan ID:** 2493
            _This release was automatically generated based on Testsigma execution._
          generate_release_notes: true
